#!/usr/bin/env python
import argparse
import re
from pathlib import Path
import shutil

from tqdm import tqdm

# Match lines like:
#   tbody_1
#   <tbody_1>
#   tbody_1.1
#   <tbody_1.1>
# with arbitrary spaces/tabs around them.
TBODY_OPEN_RE = re.compile(
    r"(?mi)^[^\S\r\n]*<?tbody_([0-9.]+)>?[^\S\r\n]*$"
)


def split_by_tbody(text: str):
    """
    Return (header, [tbody_block1, tbody_block2, ...]).

    - 'header' is everything before the first tbody line.
    - Each tbody_block starts at its tbody_X line and goes up to (but not
      including) the next tbody_X line, or EOF for the last block.

    If no tbody line is found, returns (None, None).
    """
    matches = list(TBODY_OPEN_RE.finditer(text))
    if not matches:
        return None, None

    header = text[:matches[0].start()]
    blocks = []

    for i, m in enumerate(matches):
        start = m.start()
        end = matches[i + 1].start() if i + 1 < len(matches) else len(text)
        blocks.append(text[start:end])

    return header, blocks


def process_file(src_path: Path, dst_dir: Path) -> None:
    """Process a single .txt file."""
    text = src_path.read_text(encoding="utf-8", errors="replace")

    header, blocks = split_by_tbody(text)

    # No tbody markers: copy unchanged
    if header is None or not blocks:
        dst_path = dst_dir / src_path.name
        shutil.copy2(src_path, dst_path)
        return

    # One output file per tbody block
    for i, block in enumerate(blocks, start=1):
        out_name = f"{src_path.stem}_part{i}{src_path.suffix}"
        out_path = dst_dir / out_name
        out_path.write_text(header + block, encoding="utf-8")


def main():
    parser = argparse.ArgumentParser(
        description="Split .txt files on tbody_X blocks or copy unchanged."
    )
    parser.add_argument("input_dir", help="Folder containing .txt files")
    parser.add_argument("output_dir", help="Folder for output files")
    args = parser.parse_args()

    in_dir = Path(args.input_dir)
    out_dir = Path(args.output_dir)
    out_dir.mkdir(parents=True, exist_ok=True)

    txt_files = [p for p in in_dir.glob("*.txt") if p.is_file()]

    for src in tqdm(txt_files, desc="Processing .txt files"):
        process_file(src, out_dir)


if __name__ == "__main__":
    main()