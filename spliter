#!/usr/bin/env python
import argparse
import re
from pathlib import Path
import shutil

from tqdm import tqdm


def process_file(src_path: Path, dst_dir: Path) -> None:
    """Process a single .txt file."""
    text = src_path.read_text(encoding="utf-8")

    # Split at every "<tbody" while keeping "<tbody..." at the start of each block
    parts = re.split(r'(?i)(?=<tbody)', text)  # (?i) = case-insensitive

    if len(parts) <= 1:
        # No <tbody...> â†’ simply copy file
        dst_path = dst_dir / src_path.name
        shutil.copy2(src_path, dst_path)
        return

    header = parts[0]
    tbody_blocks = parts[1:]

    for i, block in enumerate(tbody_blocks, start=1):
        out_name = f"{src_path.stem}_part{i}{src_path.suffix}"
        out_path = dst_dir / out_name
        out_path.write_text(header + block, encoding="utf-8")


def main():
    parser = argparse.ArgumentParser(
        description="Split .txt files on <tbody...> or copy unchanged if none found."
    )
    parser.add_argument("input_dir", help="Folder containing .txt files to process")
    parser.add_argument("output_dir", help="Folder where output files will be written")

    args = parser.parse_args()

    in_dir = Path(args.input_dir)
    out_dir = Path(args.output_dir)
    out_dir.mkdir(parents=True, exist_ok=True)

    txt_files = [p for p in in_dir.glob("*.txt") if p.is_file()]

    for path in tqdm(txt_files, desc="Processing .txt files"):
        process_file(path, out_dir)


if __name__ == "__main__":
    main()